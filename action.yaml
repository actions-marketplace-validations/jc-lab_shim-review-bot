name: 'shim Auto Review bot'
description: 'shim Auto Review bot'
inputs:
  issue-repository:
    description: 'issue repository'
    required: false
    default: "${{ github.repository }}"
  issue-number:
    description: 'issue number'
    required: false
  source:
    description: "source git repository"
    required: true
  build-script:
    description: 'build script'
    required: false
  output-file:
    description: 'generated by build-script output file path'
    required: false
  vendor-cert:
    description: 'vendor cert file'
    required: false
  report-output:
    description: 'review file output path'
    required: false
runs:
  using: "composite"
  steps:
    - name: setup-buildx
      uses: docker/setup-buildx-action@v3
    - run: |
        echo "${{ github.action_path }}" >> $GITHUB_PATH
        chmod +x ${{ github.action_path }}/shim-review-bot
      shell: bash
    - id: clone
      shell: bash
      run: |
        shim-review-bot download --source "${{ inputs.source }}" --dest "/tmp/source" > /tmp/working-directory.txt
    - id: review
      shell: bash
      run: |
        [ -n "${{ inputs.output-file }}" ] && export BUILD_OUTPUT_FILE="${{ inputs.output-file }}" || export BUILD_OUTPUT_FILE="output.tar"
        [ -n "${{ inputs.build-script }}" ] && BUILD_SCRIPT="${{ inputs.build-script }}" || BUILD_SCRIPT="${{ github.action_path }}/default-build-script.sh"
        [ -n "${{ inputs.vendor-cert }}" ] && export VENDOR_CERT="${{ inputs.vendor-cert }}" || export VENDOR_CERT="vendor_cert.der"
        [ -n "${{ inputs.report-output }}" ] && export REPORT_OUTPUT="${{ inputs.report-output }}" || export REPORT_OUTPUT="/tmp/report.md"
        cd $(cat /tmp/working-directory.txt)
        shim-review-bot review --build-script "${BUILD_SCRIPT}" --output-file "${BUILD_OUTPUT_FILE}" --vendor-cert "${VENDOR_CERT}" --report-output "${REPORT_OUTPUT}"
    - id: comment
      if: inputs.issue-number != ''
      uses: peter-evans/create-or-update-comment@v3.0.2
      with:
        issue-number: "${{ inputs.issue-number }}"
        body-path: "${{ inputs.report-output }}"
